<html>
<head>
<title>Test Strava API</title>
</head>

<script type="text/javascript" src="https://code.jquery.com/jquery-3.5.1.min.js">
</script>

<style>

.main_content {
	position: absolute;
	top: 5%;
	left: 2%;
	width: 96%;
	height: 90%;
	overflow: scroll;
}

.controls {
	width : 95%;
}

#loader {
	float : left;
	width : 45%;
}

#toggleGraph {
	float : left;
}

#restoreCols {
	float : right;
}

.activities_graph_canvas {
	position: relative;
	border: 1px solid black;
	margin: 20px;
	width: 620px;
	height: 200px;
}

.bar_graph {
	position: absolute;
	bottom: 0px;
	min-width: 20px;
}

.legend {
	position: absolute;
	top: 2px;
	left: 2px;
	padding: 5px;
}


</style>

<script type="text/javascript">

var ColsAreTimes = [6, 16, 17];
var ColsGpx = 13;
var ColsAvgSpeed = 20;
var ColsType = 4;
var ColsDistance = 18;
var ColsElevationGain = 21;
var ColsDate = 2;

var MonthStringToNum = {
	'Jan' : 1,
	'Feb' : 2,
	'Mar' : 3,
	'Apr' : 4,
	'May' : 5,
	'Jun' : 6,
	'Jul' : 7,
	'Aug' : 8,
	'Sep' : 9,
	'Oct' : 10,
	'Nov' : 11,
	'Dec' : 12
};
var MonthNumToString = {
	1 : 'Jan',
	2 : 'Feb',
	3 : 'Mar',
	4 : 'Apr',
	5 : 'May',
	6 : 'Jun',
	7 : 'Jul',
	8 : 'Aug',
	9 : 'Sep',
	10: 'Oct',
	11: 'Nov',
	12: 'Dec'
};
var MonthEndDate = {
	1 : 31,
	2 : 28,
	3 : 31,
	4 : 30,
	5 : 31,
	6 : 30,
	7 : 31,
	8 : 31,
	9 : 30,
	10: 31,
	11 : 30,
	12: 31
}

var stats = {
	'distance': {
	},
	'time': {
	},
	'elevation': {
	}
}

function linkActivities() {
	$('#activities_table td:first-child').each(function (i) {
		if ($(this).find('a').size > 0) {
			return;
		}
		var actId = $(this).text();
		$(this).html('<a href="https://strava.com/activities/'+actId+'">'+actId+'</a>');	
	});
}

function linkGpx () {
	$('#activities_table td:nth-child(' + ColsGpx + ')').each(function (i) {
		if ($(this).find('a').size > 0) {
			return;
		}
		var localLink = $(this).text();
		$(this).html('<a href="'+localLink+'">Gpx file</a>');	
	});
}

function formatTimes() {
	for (var i = 0; i < ColsAreTimes.length; i++) {
		$('#activities_table td:nth-child('+ColsAreTimes[i]+')').each(function (i) {
			if($(this).hasClass('formatted')) {
				return;
			}
			var timeInSec = $(this).text() * 1;
			var finalTimeSec = timeInSec % 60;
			var finalTimeMin = ((timeInSec - finalTimeSec) / 60) % 60;
			var finalTimeHour = (timeInSec - finalTimeSec - (finalTimeMin * 60)) / 3600;
			$(this).html(((finalTimeHour > 0) ? finalTimeHour + 'h ': '') + finalTimeMin.toLocaleString('it-IT', {minimumIntegerDigits: 2, useGrouping:false}) + 'm ' + ((finalTimeHour == 0) ? finalTimeSec.toLocaleString('it-IT', {minimumIntegerDigits: 2, useGrouping:false}) + 's ' : '') + '<span style="visibility:hidden;" class="orig_time_seconds">' + timeInSec + '</span>');
			
			$(this).addClass('formatted');
		});
	}
}

function calcSpeedPace () {
	$('#activities_table td:nth-child(' + ColsAvgSpeed + ')').each(function (i) {
		if ($(this).find('.elapsed').size > 0 || $(this).find('.moving').size > 0) {
			return;
		}
		var type = $(this).parent().find('td:nth-child(' + ColsType + ')').text();
		var dist = $(this).parent().find('td:nth-child(' + ColsDistance + ')').text() * 1;
		var movingTime = $(this).parent().find('td:nth-child(' + ColsAreTimes[2] + ') span.orig_time_seconds').text() * 1;
		var elapsedTime = $(this).parent().find('td:nth-child(' + ColsAreTimes[1] + ') span.orig_time_seconds').text() * 1;
		var elevationGain = $(this).parent().find('td:nth-child(' + ColsElevationGain + ')').text() * 1;
				
		if (type == 'Ride') {
			var avgMovingSpd = dist / movingTime * 3.6;
			var avgElapsedSpd = dist / elapsedTime * 3.6;
			$(this).html('<div class="elapsed">' + avgElapsedSpd.toLocaleString('it-IT', {maximumFractionDigits: 2}) + ' km/h (elps)</div>'+
						'<div class="moving">' + avgMovingSpd.toLocaleString('it-IT', {maximumFractionDigits: 2}) + ' km/h (mov)</div>');
		}
		else {
			var avgMovingSpd = movingTime / (dist / 1000);
			var avgMovingSpdSec = avgMovingSpd % 60;
			var avgMovingSpdMin = (avgMovingSpd - avgMovingSpdSec) / 60;
			var avgElapsedSpd = elapsedTime / (dist / 1000);
			var avgElapsedSpdSec = avgElapsedSpd % 60;
			var avgElapsedSpdMin = (avgElapsedSpd - avgElapsedSpdSec) / 60;
			var avgElapsedGap = elapsedTime / (dist / 1000 + elevationGain / 100);
			var avgElapsedGapSec = avgElapsedGap % 60;
			var avgElapsedGapMin = (avgElapsedGap - avgElapsedGapSec) / 60;
			var avgMovingGap = movingTime / (dist / 1000 + elevationGain / 100);
			var avgMovingGapSec = avgMovingGap % 60;
			var avgMovingGapMin = (avgMovingGap - avgMovingGapSec) / 60;
			$(this).html('<div class="elapsed">' + avgElapsedSpdMin + ':' + avgElapsedSpdSec.toLocaleString('it-IT', {minimumIntegerDigits: 2, maximumFractionDigits: 0}) + ' min/km (elps)</div>'+
						'<div class="moving">' + avgMovingSpdMin + ':' + avgMovingSpdSec.toLocaleString('it-IT', {minimumIntegerDigits: 2, maximumFractionDigits: 0}) + ' min/km (mov)</div>'+
						'<div class="elapsed_gap">' + avgElapsedGapMin + ':' + avgElapsedGapSec.toLocaleString('it-IT', {minimumIntegerDigits: 2, maximumFractionDigits: 0}) + ' min/km (elps GAP)</div>'+
						'<div class="moving_gap">' + avgMovingGapMin + ':' + avgMovingGapSec.toLocaleString('it-IT', {minimumIntegerDigits: 2, maximumFractionDigits: 0}) + ' min/km (mov GAP)</div>'
						);
		}
		$(this).css({ 'min-width': '200px' });
	});
}

function processDates() {
	$('#activities_table td:nth-child(' + ColsDate + ')').each(function (i) {
		if ($(this).find('.date_meta').size > 0) {
			return;
		}
		var dateParts = $(this).text().split(',');
		var year = dateParts[1] * 1;
		var inYearParts = dateParts[0].split(' ');
		var month = inYearParts[0];
		month = MonthStringToNum[month];
		var day = inYearParts[1];
		$(this).append('<div class="date_meta"><span class="year">' + year + '</span>'+
			'<span class="month">' + month + '</span>'+
			'<span class="day">' + day + '</span></div>');
		$(this).find('.date_meta').hide();
		$(this).css({ 'min-width': '120px' });
	});
}

function updateStats() {
	$('#activities_table tr').each(function (i) {
		var year = $(this).find('.year').text() * 1;
		var month = $(this).find('.month').text() * 1;
		var day = $(this).find('.day').text() * 1;
		
		var type = $(this).find('td:nth-child('+ColsType+')').text();
		
		var dist = $(this).find('td:nth-child('+ColsDistance+')').text() * 1;
		var time = $(this).find('.orig_time_seconds').first().text() * 1;
		var elevation = $(this).find('td:nth-child('+ColsElevationGain+')').text() * 1;
		
		for (var i = day; i <= MonthEndDate[month]; i++) {
			if (!(year in stats.distance)) {
				stats.distance[year] = {};
				stats.time[year] = {};
				stats.elevation[year] = {};
				$('#activities_graph_year').append('<option>');
				$('#activities_graph_year option').last().attr('value', year).text(year);
			}
			if (!(month in stats.distance[year])) {
				stats.distance[year][month] = {};
				stats.time[year][month] = {};
				stats.elevation[year][month] = {};
			}
			if (!(type in stats.distance[year][month])) {
				stats.distance[year][month][type] = {};
				stats.time[year][month][type] = {};
				stats.elevation[year][month][type] = {};
			}
			if (!(i in stats.distance[year][month][type])) {
				stats.distance[year][month][type][i] = 0;
				stats.time[year][month][type][i] = 0;
				stats.elevation[year][month][type][i] = 0;
			}
			stats.distance[year][month][type][i] += dist;
			stats.time[year][month][type][i] += time;
			stats.elevation[year][month][type][i] += elevation;
		}
	});
}

function updateGraphFromStats (year, month, base) {
	$('.activities_graph_canvas').remove();
	$('.graph_error').remove();

	var baseStats = stats.distance;
	if (base == 'elevation') {
		baseStats = stats.elevation;
	}
	if (base == 'time') {
		baseStats = stats.time;
	}
	
	var plotted = false;
	for (var type in baseStats[year][month]) {
		var maxMonthlyDist = baseStats[year][month][type][MonthEndDate[month]];
		
		$('#activities_graph').append('<div class="activities_graph_canvas">');
		plotted = true;
		if (base == 'distance') {
			$('.activities_graph_canvas').last().append('<div class="legend">').text(type + ': ' + (maxMonthlyDist/1000).toLocaleString('it-IT', {maximumFractionDigits: 2}) + 'km');
		}
		else if (base == 'elevation') {
			$('.activities_graph_canvas').last().append('<div class="legend">').text(type + ': ' + (maxMonthlyDist).toLocaleString('it-IT', {maximumFractionDigits: 0}) + 'm');
		}
		else if (base == 'time')
		{
			$('.activities_graph_canvas').last().append('<div class="legend">').text(type + ': ' + (maxMonthlyDist / 3600).toLocaleString('it-IT', {maximumFractionDigits: 0}) + 'h' + ((maxMonthlyDist % 3600) / 60).toLocaleString('it-IT', {maximumFractionDigits: 0}) + 'm');
		}
		for (var day in baseStats[year][month][type]) {
			var dist = baseStats[year][month][type][day];
			var leftDist = (day - 1) * 20;
			var height = (dist / maxMonthlyDist) * 200;
			$('.activities_graph_canvas').last().append('<div>');
			$('.activities_graph_canvas').last().find('div').last().addClass('bar_graph');
			$('.activities_graph_canvas').last().find('div').last().css({ 'height' : height + 'px', 'left': leftDist + 'px', 'backgroundColor' : 'red'});
		}
	}
	if (!plotted) {
		$('#activities_graph').append('<div class="graph_error">No activities found in the selected time period</div>');
	}
}

function hideColumn(elem) {
	var childPos = elem.index() + 1;
	elem.hide();
	$('#activities_table td:nth-child(' + childPos + ')').hide();
}

function readNumLines(data, countFields, startingPos, readMaxNum, showMaxNum) {
	var curPos = startingPos;
	var textLen = data.length;
	
	var countActivities = 0;
	var curActivityExtractedFields = 0;
	var curField = ''
	var isEscaped = 0;
	
	while (curPos < textLen && countActivities < readMaxNum) {
		 if (data[curPos] == '"') {
			isEscaped = 1 - isEscaped;
		 }
		 else if (data[curPos] == ',' && isEscaped == 0) {
			if (curActivityExtractedFields == 0) {
				if (countActivities < showMaxNum) {
					$('#activities_table thead').append('<tr></tr>');
				}
				else {
					$('#activities_table thead').append('<tr style="display:none;"></tr>');
				}
			}
			$('#activities_table tr').last().append('<td>'+curField+'</td>');
			curActivityExtractedFields = curActivityExtractedFields + 1;
			curField = '';
		 }
		 else if (data[curPos] == '\n' && curActivityExtractedFields >= countFields - 1) {
			$('#activities_table tr').last().append('<td>'+curField+'</td>');
			curField = '';
			curActivityExtractedFields = 0;
			countActivities = countActivities + 1;
		 }
		 else {
			curField = curField + data[curPos];
		 }
		 curPos = curPos + 1;
	}
	
	linkActivities();
	linkGpx();
	formatTimes();
	calcSpeedPace();
	processDates();
	updateStats();
	
	return curPos;
}

document.addEventListener("DOMContentLoaded", function () {

	$('.controls').append('<span id="loader">Load More</span>');
	$('.controls').append('<span id="toggleGraph">Toggle Graphs</span>');
	$('.controls').append('<span id="restoreCols">Restore All Columns</span>');
	
	$('#activities_graph').hide();

	
	$.ajax({
		url: " activities.csv",
		dataType: "text"
	}).done(function(data) {
	
		var firstLineBreak = 0;
		var firstLine = ''
		while (data[firstLineBreak] != '\n') {
			firstLine = firstLine + data[firstLineBreak];
			firstLineBreak = firstLineBreak + 1;
		}
		var fields = firstLine.split(',');
		var countFields = fields.length;
		
		$('#activities_table').append('<thead></thead>');
		fields.forEach(fld => $('#activities_table thead').append('<th>'+fld+'</th>'));
		
		var curPos = firstLineBreak + 1;
		var maxActivities = 150;
		var maxShownActivities = 50;
		$('#activities_table').append('<tbody></tbody>');
		$('#activities_table th').click(function () {
			hideColumn($(this));
		});
	

		$('#loader').click(function () {
			curPos = readNumLines(data, countFields, curPos, maxActivities, maxShownActivities);
		});		
		$('#restoreCols').click(function () {
			$('td:hidden').show();
			$('th:hidden').show();
		});		
		$('#toggleGraph').click(function () {
			if ($('#activities_graph:hidden').length > 0) {
				$('#activities_table').hide();
				$('#activities_graph').show();
				
				updateGraphFromStats($('#activities_graph_year option:selected').attr('value'), $('#activities_graph_month option:selected').attr('value'), $('#activities_graph_type option:selected').attr('value'));
			}
			else {
				$('#activities_table').show();
				$('#activities_graph').hide();
			}
		});	
		$('.graph_selector').change(function () {
			updateGraphFromStats($('#activities_graph_year option:selected').attr('value'), $('#activities_graph_month option:selected').attr('value'), $('#activities_graph_type option:selected').attr('value'));
		});
	});
});
</script>

<body>
	<div class="controls">
	</div>
	<table id="activities_table" class="main_content">
	</table>
	<div id="activities_graph" class="main_content">
		<select id="activities_graph_year" class="graph_selector">
		</select>
		<select id="activities_graph_month" class="graph_selector">
			<option value="1">Jan</option>
			<option value="2">Feb</option>
			<option value="3">Mar</option>
			<option value="4">Apr</option>
			<option value="5">May</option>
			<option value="6">Jun</option>
			<option value="7">Jul</option>
			<option value="8">Aug</option>
			<option value="9">Sep</option>
			<option value="10">Oct</option>
			<option value="11">Nov</option>
			<option value="12">Dec</option>
		</select>
		<select id="activities_graph_type" class="graph_selector">
			<option value="distance">Distance</option>
			<option value="elevation">Elevation</option>
			<option value="time">Time</option>
		</select>
	</div>
</body>
</html>